#!/usr/bin/env python
"""
Plastic
==================================
"""

from datetime import timedelta
from opendrift.readers import reader_netCDF_CF_generic
from opendrift.models.plastdrift import PlastDrift
import os
import time

# Read current data
reader_x_current = reader_netCDF_CF_generic.Reader('eastward_current3.nc')
reader_y_current = reader_netCDF_CF_generic.Reader('northward_current3.nc')

# Simulation time
start_time = reader_x_current.start_time
end_time = reader_x_current.end_time
time_window = [start_time, start_time + timedelta(hours=24*7)]

# Locations
locations = {
    'Malmo': (12.854807, 55.635840),
    'Oder': (14.080797, 54.054322),
    'Gdansk': (18.827874, 54.461684),
    'Oslo': (10.651, 59.165),
    'Gothenburg': (11.706, 57.657),
    'Riga': (24.000, 57.076),
    'Helsinki': (24.985, 60.100),
    'St Petersburg': (29.528, 60.045),
    'Stockholm': (19.500, 59.154),
    'Visby': (17.971, 57.657)
}

# Loop over locations
for name, (lon, lat) in locations.items():
    print(f"\n▶ Running simulation for {name}...")

    o = PlastDrift(loglevel=20)
    o.set_config('drift:vertical_mixing', False)
    o.set_config('drift:stokes_drift', True)
    #o.set_config('general:coastline_action','stranding') 
    o.set_config('drift:horizontal_diffusivity', 1)
    o.set_config('seed:wind_drift_factor', 0.02)
    o.set_config('drift:wind_drift_depth', 0.5)

    o.add_reader([reader_x_current, reader_y_current])

    o.seed_elements(lon, lat, radius=50, number=1000, time=time_window)

    # Output file
    outfile = f"{name}_noStranding_noWind_output.nc"
    
    # Delay to avoid file locking (optional)
    time.sleep(0.5)

    # Run the simulation
    try:
        o.run(end_time=end_time, time_step=3*3600, time_step_output=3*3600, outfile=outfile)
        print(f"✅ Finished {name} → {outfile}")
    except Exception as run_error:
        print(f"❌ Error during run for {name}: {run_error}")
        continue  # Skip to next location if this one fails